generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(uuid())
  email           String           @unique
  passwordHash    String
  displayName     String
  avatarUrl       String?
  xp              Int              @default(0)
  coins           Int              @default(0)
  level           Int              @default(1)
  isAdmin         Boolean          @default(false) // Admin flag for adding Azkars
  refreshToken    String?
  friends         Friend[]         @relation("UserFriends")
  inventory       UserItem[]
  challenges      ChallengeProgress[]
  badges          UserBadge[]
  dailyActions    DailyAction[]
  messages        Message[]
  purchases       Purchase[]
  prayerCompletions PrayerCompletion[]
  azkarCompletions AzkarCompletion[]
  fastingCompletions FastingCompletion[]
  chatGroups      ChatGroupMember[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([email])
  @@index([xp])
  @@index([coins])
}

model Friend {
  id             String   @id @default(uuid())
  user           User     @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  friendId       String
  status         FriendStatus @default(PENDING)
  createdAt      DateTime @default(now())

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
}

enum FriendStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

model Item {
  id             String   @id @default(uuid())
  name           String
  type           ItemType
  imageUrl       String?
  priceCoins     Int
  priceXp        Int       @default(0)
  rarity         ItemRarity @default(COMMON)
  createdAt      DateTime @default(now())
  userItems      UserItem[]
  purchases      Purchase[]

  @@index([type])
  @@index([rarity])
}

enum ItemType {
  HAIR
  CLOTH
  ACCESSORY
  SHOES
}

enum ItemRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

model UserItem {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId     String
  equipped   Boolean  @default(false)
  unlockedAt DateTime @default(now())

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
}

model Challenge {
  id            String   @id @default(uuid())
  title         String
  description   String
  startAt       DateTime
  endAt         DateTime
  rewardXp      Int
  rewardCoins   Int
  isGlobal      Boolean   @default(true)
  tasks         ChallengeTask[]
  progresses    ChallengeProgress[]
  createdAt     DateTime @default(now())

  @@index([startAt])
  @@index([endAt])
  @@index([isGlobal])
}

model ChallengeTask {
  id            String   @id @default(uuid())
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  challengeId   String
  title         String
  type          TaskType
  goalCount     Int?
  points        Int       @default(10)
  params        Json?

  @@index([challengeId])
}

enum TaskType {
  DAILY      // One-time daily task
  COUNT      // Counter-based task (e.g., read Quran 10 pages)
  STREAK     // Consecutive days task
  PRAYER     // Prayer-specific task (5 times daily)
  AZKAR      // Azkar counter task
}

model ChallengeProgress {
  id            String   @id @default(uuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  challengeId   String
  status        ProgressStatus @default(IN_PROGRESS)
  taskProgress  Json?
  pointsEarned  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, challengeId])
  @@index([userId])
  @@index([challengeId])
  @@index([status])
}

enum ProgressStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Badge {
  id          String   @id @default(uuid())
  name        String
  description String
  iconUrl     String?
  criteria    Json?
  users       UserBadge[]
  createdAt   DateTime @default(now())
}

model UserBadge {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  badge      Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  badgeId    String
  awardedAt  DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

model DailyAction {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  actionType  DailyActionType
  metadata    Json?
  taskId      String?  // Link to ChallengeTask if this action is for a challenge task
  count       Int      @default(1) // For counter-based actions like Azkar
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId, taskId, createdAt])
}

enum DailyActionType {
  PRAYER
  TASBEEH
  CHARITY
  AZKAR
  QURAN_READ
  DUA
  FASTING
}

// Prayer times and tracking
model PrayerTime {
  id          String   @id @default(uuid())
  date        DateTime // Date for these prayer times
  fajr        String   // Time in HH:mm format
  dhuhr       String
  asr         String
  maghrib     String
  isha        String
  location    String?  // City/location
  latitude    Float?
  longitude   Float?
  createdAt   DateTime @default(now())

  @@unique([date, latitude, longitude])
  @@index([date])
}

// Track individual prayer completions
model PrayerCompletion {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  prayerName  PrayerName
  date        DateTime // Date of the prayer (normalized to start of day)
  completedAt DateTime @default(now())
  onTime      Boolean  @default(false) // Whether prayer was done on time

  @@unique([userId, prayerName, date])
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

enum PrayerName {
  FAJR
  DHUHR
  ASR
  MAGHRIB
  ISHA
}

// Azkar Groups (e.g., Morning Azkar, Evening Azkar)
model AzkarGroup {
  id          String   @id @default(uuid())
  name        String   // e.g., "Morning Azkar", "Evening Azkar"
  nameAr      String   // Arabic name
  description String?
  icon        String?  // Icon name or emoji
  color       String?  // Hex color code
  category    AzkarCategory
  order       Int      @default(0) // Display order
  azkars      Azkar[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([order])
}

// Individual Azkar within a group
model Azkar {
  id          String   @id @default(uuid())
  group       AzkarGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId     String
  title       String
  titleAr     String   // Arabic title
  arabicText  String
  translation String
  transliteration String?
  targetCount Int      @default(1) // How many times to recite
  xpReward    Int      @default(10) // XP reward
  coinsReward Int      @default(5)  // Coins reward
  order       Int      @default(0) // Order within group
  reference   String?  // Source reference (e.g., Hadith reference)
  completions AzkarCompletion[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([groupId])
  @@index([order])
}

enum AzkarCategory {
  MORNING
  EVENING
  AFTER_PRAYER
  BEFORE_SLEEP
  GENERAL
}

// Track user's azkar completions (daily reset - can redo each day)
model AzkarCompletion {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  azkar       Azkar    @relation(fields: [azkarId], references: [id], onDelete: Cascade)
  azkarId     String
  date        DateTime // Date of completion (normalized to start of day)
  completedAt DateTime @default(now())
  xpEarned    Int
  coinsEarned Int

  @@unique([userId, azkarId, date]) // User can complete each azkar once per day
  @@index([userId])
  @@index([azkarId])
  @@index([date])
  @@index([userId, date])
}

// Fasting tracking with time restrictions
model FastingCompletion {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  date        DateTime // Date of the fast (normalized to start of day)
  fastingType FastingType @default(VOLUNTARY)
  completedAt DateTime @default(now())
  xpEarned    Int      @default(100)
  coinsEarned Int      @default(50)

  @@unique([userId, date]) // One fasting per day
  @@index([userId])
  @@index([date])
  @@index([userId, date])
}

enum FastingType {
  VOLUNTARY
  RAMADAN
  SUNNAH
}

model ChatGroup {
  id          String   @id @default(uuid())
  name        String
  type        GroupType
  challengeId String?  // Optional reference to challenge
  createdAt   DateTime @default(now())
  messages    Message[]
  members     ChatGroupMember[]

  @@index([type])
  @@index([challengeId])
}

model ChatGroupMember {
  id        String    @id @default(uuid())
  group     ChatGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  joinedAt  DateTime  @default(now())

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

enum GroupType {
  PUBLIC
  PRIVATE
  CHALLENGE
  USER
}

model Message {
  id          String   @id @default(uuid())
  group       ChatGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId     String
  sender      User      @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId    String
  content     String
  createdAt   DateTime @default(now())

  @@index([groupId])
  @@index([senderId])
  @@index([createdAt])
}

model LeaderboardSnapshot {
  id           String   @id @default(uuid())
  type         LeaderboardType
  snapshotAt   DateTime @default(now())
  payload      Json

  @@index([type])
  @@index([snapshotAt])
}

enum LeaderboardType {
  XP
  COINS
  CHALLENGE
}

model Purchase {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  item         Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId       String
  priceCoins   Int
  createdAt    DateTime @default(now())
  status       PurchaseStatus @default(SUCCESS)

  @@index([userId])
  @@index([itemId])
  @@index([status])
}

enum PurchaseStatus {
  SUCCESS
  FAILED
  REFUNDED
}